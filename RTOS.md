

## Как правильно настроить UART и RTOS (FreeRTOS) в STM32CubeMX

### Шаг 1. Запуск STM32CubeMX

- Откройте программу **STM32CubeMX**.
- Создайте новый проект или откройте существующий.

---

### Шаг 2. Выбор микроконтроллера или платы

- В окне выбора микроконтроллера найдите нужную модель (например, STM32F103C8) или выберите вашу плату Nucleo/Discovery.
- Нажмите "Start Project".

---

### Шаг 3. Включение UART

1. **Перейдите в раздел “Pinout & Configuration”:**
   - На схеме микроконтроллера найдите пины UART (например, PA2 — TX, PA3 — RX для UART2).
   - Кликните на нужный пин и выберите функцию **USARTx_TX** и **USARTx_RX**.

2. **Откройте вкладку “Configuration” (справа):**
   - Найдите **USARTx** (например, USART2).
   - Откройте настройки, нажав на шестерёнку рядом с USART.

3. **Настройте параметры UART:**
   - **Baud Rate** (скорость передачи, например, 115200)
   - **Word Length** (длина слова, обычно 8 бит)
   - **Parity** (четность, обычно None)
   - **Stop Bits** (количество стоп-битов, обычно 1)
   - **Hardware Flow Control** (обычно None, если не используется RTS/CTS)
   - **Mode**: выберите "Asynchronous" (Асинхронный режим)

4. **Включите необходимые прерывания или DMA:**
   - Для работы с FreeRTOS рекомендуется использовать **Interrupt (IT)** или **DMA** режимы для неблокирующей передачи данных.
   - В разделе "NVIC Settings" (настройки прерываний) убедитесь, что прерывания для выбранного UART включены.

---

### Шаг 4. Включение RTOS (FreeRTOS)

1. **Перейдите в раздел “Middleware” (слева):**
   - Найдите пункт **FreeRTOS** и установите галочку.

2. **Откройте настройки FreeRTOS:**
   - Перейдите во вкладку **Configuration** → **FreeRTOS**.

3. **Создайте задачи (Tasks):**
   - В разделе “Tasks and Queues” добавьте задачи (например, `UARTTask`).
   - Для каждой задачи настройте:
     - **Имя**
     - **Stack size** (размер стека, например, 256)
     - **Priority** (приоритет, например, osPriorityNormal)
     - **Entry function** (функция, которая будет выполняться в задаче)

4. **Настройте дополнительные объекты RTOS:**
   - При необходимости добавьте очереди (`Queues`), семафоры (`Semaphores`), таймеры (`Timers`) и другие объекты FreeRTOS.

---

### Шаг 5. Генерация кода

- Нажмите **"Project"** → заполните поля (имя проекта, путь, IDE — например, STM32CubeIDE).
- Нажмите **"Generate Code"**.
- Откройте проект в выбранной IDE.

---

### Шаг 6. Проверка и интеграция UART с FreeRTOS

1. **В файле задач (например, `uartTask.c`):**
   - Используйте неблокирующие функции передачи данных, например, `HAL_UART_Transmit_IT()` или `HAL_UART_Transmit_DMA()`.
   - Для приема данных используйте `HAL_UART_Receive_IT()` или `HAL_UART_Receive_DMA()`.

2. **Обработка завершения передачи/приёма:**
   - Реализуйте обработчики событий (callback-функции):
     ```c
     // Функция вызывается по завершении передачи
     void HAL_UART_TxCpltCallback(UART_HandleTypeDef *huart) {
         // Здесь можно отправить уведомление задаче через FreeRTOS-примитив
     }

     // Функция вызывается по завершении приёма
     void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart) {
         // Здесь можно обработать принятые данные
     }
     ```

3. **Рекомендуемый подход:**
   - Для общения между задачами используйте **FreeRTOS очереди (Queues)**.
   - Одна задача кладёт данные в очередь, другая задача отвечает за отправку их через UART.

---

### Шаг 7. Важно: Особенности интеграции

- **Не используйте блокирующую функцию `HAL_UART_Transmit()` внутри задач FreeRTOS!**  
  Она может заблокировать задачу и повлиять на работу системы.
- Всегда используйте **прерывания (Interrupt, IT)** или **DMA** для передачи/приема, чтобы задачи не простаивали в ожидании.

---

## Итог

**Краткий алгоритм настройки UART и FreeRTOS в CubeMX:**

1. Включите периферию UART в Pinout.
2. Настройте параметры UART (скорость, стоп-биты, режим).
3. Включите прерывания или DMA для UART.
4. Активируйте FreeRTOS в разделе Middleware.
5. Создайте задачи и необходимые объекты RTOS.
6. Сгенерируйте проект, интегрируйте неблокирующую работу с UART через IT или DMA.
7. Используйте callback-функции для взаимодействия между задачами и обработчиками событий UART.

---

Если требуется пример кода для реализации задачи FreeRTOS с передачей по UART — напишите, подготовлю подробный шаблон!
